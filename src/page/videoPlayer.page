<template lang="pug">
.video-box#videoBox()
  img.android-bg(src="@&click-bg.jpg&", @click="play")
  video#videoPlay(
    src="@&enter.mp4&",
    preload="auto",
    autoplay= "true",
    webkit-playsinline="true",
    playsinline="true",
    x5-video-player-type="h5",
    x5-video-player-fullscreen="false",
    ontouchstart="return false;"
  )
  .text#text
</template>

<script>
  module.exports = {
    data: {
      isplay: false,
      canPlay: false,
      weixinReady: false,
      imgArr: []
    },
    created: function () {
      // 判断是否为安卓手机，如果是安卓手机需要点击播放视频
      const u = window.navigator.userAgent.toLowerCase()
      const isAndroid = u.indexOf('android') > -1 || u.indexOf('linux') > -1
      const isWeiXin = u.match(/MicroMessenger/i) == 'micromessenger'
      const isIOS = /(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)

      // 屏幕大小改变刷新页面
      window.onresize = function(){
        window.location.reload()
      }
      // 视频播放器
      const videoPlay = $('#videoPlay')
      const body = $('body')[0]

      // 如果不在微信环境下默认就可以播放
      this.data.weixinReady = !isWeiXin
      // ios不会触发oncanplay事件
      if (isIOS) this.data.canPlay = true
      // 视频加载完毕事件
      videoPlay.oncanplay = () => {
        // alert('视频准备就绪')
        // 视频可以进行播放
        this.data.canPlay = true
        
        if (this.data.canPlay && this.data.weixinReady && !isAndroid) {
          // 这里如果不加setTimeout PC端会报错
          setTimeout(() => {
            videoPlay.play()
          }, 0)
          
        }
      }
      // 屏幕信息
      const screenInfo = $tool.getScreenInfo()
      // 视频分辨率比例
      const videoRatio = 1920 / 1080
      
      let cw = screenInfo.clientWidth
      let ch = screenInfo.clientHeight
      
      console.log(`屏幕分辨率比: ${screenInfo.ratio}`)
      console.log(`视频分辨率比: ${videoRatio}`)
      // 判断是横屏还是竖屏
      if (screenInfo.ratio < 1) {
        console.log('竖屏模式!')
        cw = screenInfo.clientHeight
        ch = screenInfo.clientWidth
        // if (isAndroid) {
        //   cw = cw + 200
        // }
        // 竖屏处理
        body.style.position = 'absolute'
        body.style.width = screenInfo.clientHeight + 'px'
        body.style.height = screenInfo.clientWidth + 'px'
        body.style.transform = 'translate3d(0, 0, 0) rotate(90deg)'
        body.style.left = 'calc(50% - ' + screenInfo.clientHeight / 2 + 'px)'
        body.style.top = 'calc(50% - ' + screenInfo.clientWidth / 2 + 'px)'

        // 判断以高度为基准还是以宽度为基准
        if (videoRatio > screenInfo.ratio) {
          const videoHeight = cw / videoRatio
          videoPlay.style.width = cw + 'px'
          videoPlay.style.height = videoHeight + 'px'
          // 将视频1保持在中间
          videoPlay.style.top = -(videoHeight - ch) / 2 + 'px'
        } else {
          console.log('以高度为基准!')
          const videoWidth = ch * videoRatio
          videoPlay.style.height = ch + 'px'
          videoPlay.style.width = videoWidth + 'px'
          // 将视频1保持在中间
          videoPlay.style.left = -(videoWidth - cw) / 2 + 'px'
        }
      } else {
        // console.log(videoRatio, screenInfo.ratio)
        // 判断以高度为基准还是以宽度为基准
        if (videoRatio > screenInfo.ratio) {
          console.log('以高度为基准!')
          const videoWidth = ch * videoRatio
          videoPlay.style.height = ch + 'px'
          videoPlay.style.width = videoWidth + 'px'
          // 将视频1保持在中间
          videoPlay.style.left = -(videoWidth - cw) / 2 + 'px'
        } else {
          const videoHeight = cw / videoRatio
          videoPlay.style.width = cw + 'px'
          videoPlay.style.height = videoHeight + 'px'
          // 将视频1保持在中间
          videoPlay.style.top = -(videoHeight - ch) / 2 + 'px'
        }
      }
      
      videoPlay.ontimeupdate = (e) => {
        if (e.target.currentTime > 18) {
          this.playVideo()
        }
      }
      // 方法
      document.addEventListener('WeixinJSBridgeReady', () => {
        this.data.weixinReady = true
        // alert('微信准备就绪')
        // alert(this.data.canPlay)
        if (this.data.canPlay && this.data.weixinReady) {
          // alert('开始播放')
          videoPlay.play()
        }
      }, false)

      if (isAndroid || (isIOS && !isWeiXin)) {
        console.log('是安卓, 显示遮蔽层!')
        $('.android-bg')[0].style.display = 'block'
      }
      // 加载文字图片
      for (var i = 0; i < 42; i++) {
        this.data.imgArr.push(`image/${i}.png`);
      }
      loadImages({loadArr: this.data.imgArr})
    },
    play: function () {
      // 视频播放器
      this.$el.style.display = 'none'
      const videoPlay = $('#videoPlay')
      console.log('点击播放')
      videoPlay.play()
    },
    playVideo: function () {
      if (this.data.isplay) return
      this.data.isplay = true
      console.log('开始播放了')
      const textRatio = 1018 / 824
      $("#text").style.height = $tool.getScreenInfo().clientHeight * 0.8 + 'px'
      $("#text").style.width = $tool.getScreenInfo().clientHeight * 0.5 * textRatio + 'px'
      
      let framePlayer = new vFramePlayer({
        dom: $("#text"),
        imgArr: this.data.imgArr,
        useCanvas: true
      })
      framePlayer.play(0, 41, {
        "fps": 6,
        "useCanvas": true,
        onComplete: function () {
          console.log("完成播放")
          $('#videoBox').style.opacity = 0
          // 视频播放完毕等候1秒销毁视频
          setTimeout(() => {
            $('#videoBox').innerHTML = ''
            $('#videoBox').style.display = 'none'
          }, 1000)
        }
      })
    }
  }
</script>


<style lang="less">
  .video-box {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: fixed;
    text-align: center;
    align-items: center;
    object-fit: fill;
    opacity: 1;
    transition: opacity 1s;
    background-color: black;
    video {
      height: 100%;
      margin: auto;
      left: 0;
      top: 0;
      position: absolute;
    }
    .text {
      color: white;
      position: fixed;
      left: 5%;
      top: 0;
      bottom: 0;
      margin: auto;
    }
  }
  .android-bg {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 99;
    display: none;
  }
</style>